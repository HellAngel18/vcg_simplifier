<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mesh Simplifier - Compare View</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        body { font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; height: 100vh; margin: 0; background-color: #1e1e1e; color: #fff; }
        
        /* 左侧边栏 */
        .sidebar { width: 320px; padding: 20px; background: #2d2d2d; border-right: 1px solid #444; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; box-shadow: 2px 0 5px rgba(0,0,0,0.3); z-index: 10; }
        .sidebar h2 { margin-top: 0; font-size: 1.2rem; color: #ddd; border-bottom: 1px solid #555; padding-bottom: 10px; }
        
        /* 表单样式 */
        .form-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.9rem; color: #aaa; font-weight: 600; }
        input[type="number"], input[type="text"], input[type="file"] { 
            background: #3d3d3d; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; 
        }
        input[type="checkbox"] { transform: scale(1.2); margin-right: 8px; }
        .checkbox-label { flex-direction: row; align-items: center; cursor: pointer; }
        small { font-size: 0.75rem; color: #888; }
        
        /* 按钮样式 */
        .btn { padding: 12px; background: #0078d4; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: background 0.2s; margin-top: 10px; }
        .btn:hover { background: #106ebe; }
        .btn:disabled { background: #555; cursor: not-allowed; }
        .loading { display: none; text-align: center; color: #00aaff; font-size: 0.9rem; margin-top: 10px; }

        /* 主视图区域 (网格布局) */
        .main-content { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background-color: #000; position: relative; }
        
        /* 单个视口容器 */
        .viewer-wrapper { position: relative; width: 100%; height: 100%; background: #222; overflow: hidden; }
        
        /* 标签 (Original / Simplified) */
        .viewer-label { 
            position: absolute; top: 15px; left: 15px; 
            background: rgba(0, 0, 0, 0.7); color: white; 
            padding: 5px 12px; border-radius: 20px; 
            font-size: 0.85rem; pointer-events: none; z-index: 5; border: 1px solid rgba(255,255,255,0.2);
        }

        /* 模型组件 */
        model-viewer { width: 100%; height: 100%; --poster-color: transparent; }

        /* 响应式调整：小屏幕上下排列 */
        @media (max-width: 900px) {
            .main-content { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>Simplifier Config</h2>
    
    <div class="form-group">
        <label>Upload Model (.glb / .obj)</label>
        <input type="file" id="fileInput" accept=".glb,.obj" onchange="previewOriginal(this)">
    </div>

    <div class="form-group">
        <label>Ratio (0.0 - 1.0)</label>
        <input type="number" id="ratio" value="0.5" step="0.05" min="0" max="1">
        <small>Overrides Target Count if > 0</small>
    </div>

    <div class="form-group">
        <label>Target Face Count</label>
        <input type="number" id="targetCount" value="0" step="100">
        <small>Used if Ratio is 0</small>
    </div>

    <div class="form-group">
        <label>Texture Weight</label>
        <input type="number" id="textureWeight" value="10.0" step="1.0">
        <small>Recommend 10+ for buildings</small>
    </div>

    <div class="form-group">
        <label>Boundary Weight</label>
        <input type="number" id="boundaryWeight" value="20.0" step="1.0">
        <small>Recommend 20+ for sharp edges</small>
    </div>
    
    <div class="form-group">
        <label>Quality Threshold</label>
        <input type="number" id="quality" value="0.3" step="0.1">
    </div>

    <div class="form-group checkbox-label">
        <input type="checkbox" id="preserveBoundary" checked> 
        <label for="preserveBoundary" style="cursor:pointer; margin:0;">Preserve Boundary</label>
    </div>

    <div class="form-group checkbox-label">
        <input type="checkbox" id="preserveTopology" checked>
        <label for="preserveTopology" style="cursor:pointer; margin:0;">Preserve Topology</label>
    </div>

    <button class="btn" onclick="processFile()" id="submitBtn">Simplify & Render</button>
    <div class="loading" id="loadingMsg">
        Processing...<br>
        <span style="font-size:0.8em; color:#888;">Large models may take a few seconds</span>
    </div>
</div>

<div class="main-content">
    
    <div class="viewer-wrapper">
        <div class="viewer-label">Original Model</div>
        <model-viewer id="viewer-original" 
                      camera-controls 
                      disable-tap
                      shadow-intensity="1.5"
                      shadow-softness="0.5"
                      exposure="1.0"
                      environment-image="https://modelviewer.dev/shared-assets/environments/moon_1k.hdr"
                      alt="Original Model">
            <div slot="progress-bar"></div>
        </model-viewer>
    </div>

    <div class="viewer-wrapper">
        <div class="viewer-label">Simplified Result</div>
        <model-viewer id="viewer-simplified" 
                      camera-controls 
                      disable-tap
                      shadow-intensity="1.5"
                      shadow-softness="0.5"
                      exposure="1.0"
                      environment-image="https://modelviewer.dev/shared-assets/environments/moon_1k.hdr"
                      alt="Simplified Model">
             <div slot="poster" style="display:flex; justify-content:center; align-items:center; height:100%; color:#555;">
                Waiting for simplification...
            </div>
        </model-viewer>
    </div>

</div>

<script>
    const viewerOriginal = document.getElementById('viewer-original');
    const viewerSimplified = document.getElementById('viewer-simplified');

    // --- 功能 1: 原始模型预览 (无需后端) ---
    function previewOriginal(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            // 创建本地 Blob URL，秒开
            const url = URL.createObjectURL(file);
            viewerOriginal.src = url;
            
            // 清空右侧简化结果，避免误导
            viewerSimplified.src = ""; 
        }
    }

    // --- 功能 2: 提交后端进行简化 ---
    async function processFile() {
        const fileInput = document.getElementById('fileInput');
        if (!fileInput.files[0]) {
            alert("Please select a file first!");
            return;
        }

        const btn = document.getElementById('submitBtn');
        const loading = document.getElementById('loadingMsg');
        btn.disabled = true;
        loading.style.display = 'block';

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        // 获取所有参数
        formData.append('ratio', document.getElementById('ratio').value);
        formData.append('target_count', document.getElementById('targetCount').value);
        formData.append('quality', document.getElementById('quality').value);
        formData.append('texture_weight', document.getElementById('textureWeight').value);
        formData.append('boundary_weight', document.getElementById('boundaryWeight').value);
        formData.append('preserve_boundary', document.getElementById('preserveBoundary').checked);
        formData.append('preserve_topology', document.getElementById('preserveTopology').checked);

        try {
            const response = await fetch('/simplify', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(errText);
            }

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);

            // 更新右侧视口
            viewerSimplified.src = url;
            
        } catch (err) {
            alert("Error: " + err.message);
        } finally {
            btn.disabled = false;
            loading.style.display = 'none';
        }
    }

    // --- (可选) 功能 3: 简单的相机同步 ---
    // 当在其中一个窗口操作相机时，尝试把角度复制到另一个窗口
    // 注意：由于 model-viewer 的事件限制，完美的实时同步比较复杂，这里做一个简单的交互优化
    const syncCamera = (source, target) => {
        if (!source.loaded || !target.loaded) return;
        // 获取当前相机的轨道角度 (Theta, Phi, Radius)
        const orbit = source.getCameraOrbit();
        // 将目标相机的轨道设置为相同
        target.cameraOrbit = `${orbit.theta}rad ${orbit.phi}rad ${orbit.radius}m`;
        target.fieldOfView = source.getFieldOfView();
        target.jumpCameraToGoal();
    };

    // 监听用户交互结束事件 (interaction-end) 进行一次同步
    // 这样不会太卡顿，但能保证松手后视角一致
    viewerOriginal.addEventListener('camera-change', (e) => {
        if (e.detail.source === 'user-interaction') {
             // 简单的实时同步尝试 (可能会有轻微延迟)
             syncCamera(viewerOriginal, viewerSimplified);
        }
    });
    
    viewerSimplified.addEventListener('camera-change', (e) => {
        if (e.detail.source === 'user-interaction') {
             syncCamera(viewerSimplified, viewerOriginal);
        }
    });

</script>

</body>
</html>